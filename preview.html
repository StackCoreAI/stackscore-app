<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Credit Stack Plans</title>

  <script>
    (function () {
      try { if (!localStorage.getItem('stackscoreUserData')) location.replace('/wizard.html'); }
      catch { location.replace('/wizard.html'); }
    })();
  </script>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    html { scroll-behavior:smooth } body { font-family:'Inter', sans-serif }
    @keyframes fadeSlide { 0%{opacity:0;transform:translateY(12px);filter:blur(3px)} 100%{opacity:1;transform:translateY(0);filter:blur(0)} }
    .fade-slide { animation: fadeSlide .7s ease forwards }
    .fade-delay-1{animation-delay:.1s}.fade-delay-2{animation-delay:.2s}.fade-delay-3{animation-delay:.3s}.fade-delay-4{animation-delay:.4s}

    /* Loader overlay (same array as wizard) */
    #spinnerMask { position:fixed; inset:0; z-index:80; display:none }
    #spinnerMask.active { display:block }
    .mask-bg { position:absolute; inset:0; background:rgba(0,0,0,.55); backdrop-filter: blur(10px) saturate(105%) }
    .spinner-wrap { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none }
    @keyframes floatUp { 0%{transform:translateY(10px);opacity:0} 50%{opacity:1} 100%{transform:translateY(-10px);opacity:0} }
    .score-burst span{ animation: floatUp 4s ease-in-out infinite }
    .score-burst span:nth-child(odd){animation-delay:1s}.score-burst span:nth-child(even){animation-delay:2s}
    .loader-caption{ color:#cbd5e1; font-size:.9rem; text-align:center; margin-top:10px }

    #statusBar{position:sticky;top:0;z-index:60}
    .status-inner{display:flex;align-items:center;gap:.75rem;justify-content:space-between}
    .status-text{color:#f1f5f9}.status-note{color:#eab308}

    #toast{position:fixed;bottom:16px;right:16px;z-index:90}
    .toast-card{background:#052e16;border:1px solid #14532d;color:#d9f99d;padding:.6rem .75rem;border-radius:.75rem;box-shadow:0 10px 30px rgba(0,0,0,.35)}

    .content-hidden { opacity:0; transform:translateY(6px); filter:blur(2px); transition:all .45s ease }
    .content-shown  { opacity:1; transform:none; filter:none }

    /* Friendly fatal error modal */
    #fatalCard{ display:none; }
    #fatalCard.on{ display:block; }
    .fatal-wrap{ position:fixed; inset:0; z-index:90; display:grid; place-items:center; padding:1rem; }
    .fatal-bg{ position:absolute; inset:0; background:rgba(0,0,0,.65); backdrop-filter:blur(8px) saturate(110%); }
    .fatal-card{
      position:relative; z-index:1;
      width:min(560px,92vw);
      border-radius:14px;
      background:linear-gradient(180deg, rgba(23,23,23,.96), rgba(12,12,12,.96));
      border:1px solid #3f3f46;
      box-shadow:0 24px 64px rgba(0,0,0,.5);
    }
    .fatal-actions > button{ transition: transform .08s ease, filter .2s ease; }
    .fatal-actions > button:active{ transform: translateY(1px); }
  </style>
</head>

<body class="bg-neutral-950 text-white p-8 space-y-12">
  <nav class="flex items-center justify-between sticky top-0 z-50 bg-neutral-950/90 py-4 border-b border-neutral-800 px-2">
    <div class="flex items-center gap-3 pl-1">
      <svg class="text-lime-400" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <path d="M4 4h16v3H4z"></path><path d="M4 10.5h16v3H4z"></path><path d="M4 17h16v3H4z"></path>
      </svg>
      <span class="text-white font-semibold tracking-tight">StackScore</span>
    </div>
    <div class="flex justify-center gap-6">
      <a href="#planA" class="text-lime-300 underline font-medium hover:text-lime-400">Plan A</a>
      <a href="#planB" class="text-lime-300 underline font-medium hover:text-lime-400">Plan B</a>
      <a href="#planC" class="text-lime-300 underline font-medium hover:text-lime-400">Plan C</a>
      <a href="#planD" class="text-lime-300 underline font-medium hover:text-lime-400">Plan D</a>
    </div>
    <div id="stamp" class="text-xs pr-2 text-neutral-400"></div>
  </nav>

  <!-- CREDIT SCORE LOADER -->
  <div id="spinnerMask" class="active" aria-live="polite" aria-busy="true">
    <div class="mask-bg"></div>
    <div class="spinner-wrap">
      <div class="text-center">
        <div class="score-burst pointer-events-none w-[520px] max-w-[86vw] select-none relative mx-auto" style="margin:-20px 0; height:3.5rem;">
          <span class="absolute top-0 left-1/3 text-xl font-bold text-lime-400">+25</span>
          <span class="absolute top-1 left-1/4 text-2xl font-bold text-lime-300">+111</span>
          <span class="absolute top-10 left-10 text-xl font-bold text-lime-400">+65</span>
          <span class="absolute top-16 left-1/2 text-2xl font-bold text-lime-500">+53</span>
          <span class="absolute top-6 right-1/4 text-xl font-bold text-lime-400">+77</span>
          <span class="absolute top-20 right-8 text-xl font-bold text-lime-300">+121</span>
        </div>
        <div class="loader-caption">Building your stackâ€¦</div>
      </div>
    </div>
  </div>

  <!-- Friendly error modal -->
  <div id="fatalCard" class="fatal-wrap" role="dialog" aria-modal="true" aria-labelledby="fatal-title" aria-describedby="fatal-desc">
    <div class="fatal-bg"></div>
    <div class="fatal-card p-6">
      <div class="flex items-start gap-4">
        <div class="text-3xl">ðŸ˜•</div>
        <div class="flex-1">
          <h2 id="fatal-title" class="text-xl font-semibold mb-1">We couldnâ€™t load your plans</h2>
          <p id="fatal-desc" class="text-sm text-slate-300">
            Our AI helper had trouble and the quick preview wasnâ€™t available. Your answers are saved â€” try again,
            use the last saved plans, or go back to the wizard.
          </p>
        </div>
      </div>
      <div class="fatal-actions mt-5 flex flex-wrap items-center gap-3">
        <button id="fatalRetry" class="px-4 py-2 rounded-full bg-lime-400 text-black font-semibold hover:brightness-110">Try again</button>
        <button id="fatalUseSaved" class="px-4 py-2 rounded-full border border-white/25 hover:bg-white/5 hidden">Use last saved plans</button>
        <a id="fatalWizard" href="/wizard.html" class="px-4 py-2 rounded-full border border-white/25 hover:bg-white/5">Back to wizard</a>
      </div>
      <div class="mt-4 text-xs text-slate-400">Error code: <span id="fatalCode">timeout</span></div>
    </div>
  </div>

  <!-- Status Bar -->
  <div id="statusBar" class="hidden bg-amber-900/70 border-y border-amber-800">
    <div class="max-w-5xl mx-auto px-6 py-3 status-inner">
      <div class="status-text"><strong>Quick preview</strong> â€” AI is still building your best stack. <span class="status-note">You can use these now or try AI again.</span></div>
      <div class="flex items-center gap-2">
        <button id="pinPlansBtn" class="px-3 py-1.5 rounded-full bg-lime-400 text-black font-semibold">Use these</button>
        <button id="retryBtn" class="px-3 py-1.5 rounded-full border border-white/20 hover:bg-white/5">Try AI again</button>
      </div>
    </div>
  </div>

  <!-- CONTENT -->
  <main id="content" class="content-hidden">
    <section id="planA" class="fade-slide fade-delay-1 scroll-mt-24 bg-neutral-900 p-6 rounded-xl shadow-lg">
      <div class="flex items-center gap-2 mb-2"><span class="text-lime-400 font-bold">ðŸ’° Best Value</span><h2 class="text-2xl font-semibold tracking-tight">Plan A â€“ Foundation Stack</h2></div>
      <p class="text-sm text-neutral-300">Perfect for credit newbies who need a quick, low-cost boost.</p>
      <p class="text-sm text-neutral-400 mb-4">Boost: <strong>+30â€“45 pts</strong> â€¢ Time: <strong>5â€“8 mins</strong> â€¢ Cost: <strong>$12/mo</strong></p>
      <div class="plan-apps space-y-4"></div>
      <div class="flex justify-start mt-6"><button class="bg-lime-400 text-black font-semibold px-6 py-2 rounded-full">Download PDF</button></div>
    </section>

    <section id="planB" class="fade-slide fade-delay-2 scroll-mt-24 bg-neutral-900 p-6 rounded-xl shadow-lg">
      <div class="flex items-center gap-2 mb-2"><span class="text-lime-400 font-bold">ðŸ”¥ Popular Choice</span><h2 class="text-2xl font-semibold tracking-tight">Plan B â€“ Growth Stack</h2></div>
      <p class="text-sm text-neutral-300">Ideal for those with some history who want a stronger, balanced lift.</p>
      <p class="text-sm text-neutral-400 mb-4">Boost: <strong>+45â€“60 pts</strong> â€¢ Time: <strong>8â€“10 mins</strong> â€¢ Cost: <strong>$25/mo</strong></p>
      <div class="plan-apps space-y-4"></div>
      <div class="flex justify-start mt-6"><button class="bg-lime-400 text-black font-semibold px-6 py-2 rounded-full">Download PDF</button></div>
    </section>

    <section id="planC" class="fade-slide fade-delay-3 scroll-mt-24 bg-neutral-900 p-6 rounded-xl shadow-lg">
      <div class="flex items-center gap-2 mb-2"><span class="text-lime-400 font-bold">ðŸš€ Power Boost</span><h2 class="text-2xl font-semibold tracking-tight">Plan C â€“ Accelerator Stack</h2></div>
      <p class="text-sm text-neutral-300">For users ready to mix revolving and installment credit for depth.</p>
      <p class="text-sm text-neutral-400 mb-4">Boost: <strong>+60â€“75 pts</strong> â€¢ Time: <strong>10â€“12 mins</strong> â€¢ Cost: <strong>$35/mo</strong></p>
      <div class="plan-apps space-y-4"></div>
      <div class="flex justify-start mt-6"><button class="bg-lime-400 text-black font-semibold px-6 py-2 rounded-full">Download PDF</button></div>
    </section>

    <section id="planD" class="fade-slide fade-delay-4 scroll-mt-24 bg-neutral-900 p-6 rounded-xl shadow-lg">
      <div class="flex items-center gap-2 mb-2"><span class="text-lime-400 font-bold">ðŸ’Ž Premium</span><h2 class="text-2xl font-semibold tracking-tight">Plan D â€“ Elite Stack</h2></div>
      <p class="text-sm text-neutral-300">Maximum impact for ambitious users aiming for excellent scores.</p>
      <p class="text-sm text-neutral-400 mb-4">Boost: <strong>+75â€“100 pts</strong> â€¢ Time: <strong>12â€“15 mins</strong> â€¢ Cost: <strong>$55/mo</strong></p>
      <div class="plan-apps space-y-4"></div>
      <div class="flex justify-start mt-6"><button class="bg-lime-400 text-black font-semibold px-6 py-2 rounded-full">Download PDF</button></div>
    </section>
  </main>

  <div id="toast" class="hidden"><div class="toast-card">Upgraded with AI âœ¨</div></div>

  <script>
    const ENTRY_KEY='stackscoreUserData', ACCESS_KEY='stackscoreAccess';
    const hasAccess = localStorage.getItem(ACCESS_KEY) === 'true';
    const visibleCap = hasAccess ? 6 : 1;
    const MIN_ROWS = 3; // keep at least this many rows per plan

    const qs = (s,r=document)=>r.querySelector(s);
    const content=qs('#content'), spinner=qs('#spinnerMask'), statusBar=qs('#statusBar');
    const pinBtn=qs('#pinPlansBtn'), retryBtn=qs('#retryBtn'), stampEl=qs('#stamp'), toastEl=qs('#toast');

    const fatalCard=qs('#fatalCard'), fatalCodeEl=qs('#fatalCode');
    const fatalRetryBtn=qs('#fatalRetry'), fatalUseSavedBtn=qs('#fatalUseSaved');

    let pinned=false, currentPlans=null;

    function showSpinner(){ spinner.classList.add('active'); content.classList.remove('content-shown'); content.classList.add('content-hidden'); }
    function hideSpinner(){ spinner.classList.remove('active'); content.classList.remove('content-hidden'); content.classList.add('content-shown'); }
    function showStatus(){ statusBar.classList.remove('hidden'); } function hideStatus(){ statusBar.classList.add('hidden'); }

    // --- DEBUG STAMP with color cue ---
    function setStamp(source){
      const ts = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      const isLive = source === 'ai';
      const badgeClass = isLive
        ? 'bg-lime-500/15 text-lime-300 border border-lime-500/30'
        : 'bg-amber-500/15 text-amber-300 border border-amber-500/30';
      const label = isLive ? 'LIVE GPT' : 'MOCK PREVIEW';

      stampEl.innerHTML = `
        <span class="text-neutral-400">${isLive ? 'Generated by AI' : 'Quick preview'} â€¢ ${ts}</span>
        <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold tracking-wide ${badgeClass}">
          ${label}
        </span>
      `;
    }

    function showToast(msg='Upgraded with AI âœ¨'){
      toastEl.querySelector('.toast-card').textContent=msg;
      toastEl.classList.remove('hidden');
      setTimeout(()=>toastEl.classList.add('hidden'),1800);
    }

    function appCard(app, idx){
      return `<div class="bg-neutral-800 p-4 rounded-md space-y-2">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-1.5">
            <span class="w-6 h-6 flex items-center justify-center bg-lime-400 text-black font-bold rounded-full text-sm">${idx+1}</span>
            <h3 class="font-semibold">${app.app_name}</h3>
          </div>
          ${app.app_category?`<span class="text-xs bg-neutral-700 rounded-full px-2 py-1">${app.app_category}</span>`:''}
        </div>
        ${app.app_description?`<p class="text-sm text-neutral-300">${app.app_description}</p>`:''}
        ${app.app_cost?`<p class="text-sm italic text-neutral-500">Cost: ${app.app_cost}</p>`:''}
        ${app.app_url?`<a href="${app.app_url}" target="_blank" class="text-lime-400 underline text-sm">Visit App</a>`:''}
      </div>`;
    }
    function lockedCard(i){ return `<div class="bg-neutral-800 p-4 rounded-md text-center text-neutral-400 italic border border-neutral-700">ðŸ”’ App ${i+1} is hidden â€” unlock with StackScore Access</div>`; }

    const allowTerms=['credit','score','report','dispute','builder','card','bank','banking','finance','financial','budget','subscription','utility','rent','bill','identity','monitor','fraud','debt','loan'];
    const blockTerms=['fitness','workout','diet','meditation','sleep','steps','calorie','health'];
    function isOnTopic(app){ const hay=`${app.app_name||''} ${app.app_description||''} ${app.app_category||''}`.toLowerCase(); if(blockTerms.some(t=>hay.includes(t))) return false; return allowTerms.some(t=>hay.includes(t)); }
    function filterApps(apps){ if(!Array.isArray(apps)) return []; const keep=apps.filter(isOnTopic); return keep.length?keep:apps.slice(0,1).filter(isOnTopic); }

    function renderPlan(sectionId, plan){
      const section=document.getElementById(sectionId); if(!section) return;
      const rows=qs('.plan-apps', section); if(!rows) return;

      const apps=filterApps(Array.isArray(plan?.apps)?plan.apps:[]);
      if(apps.length===0){
        rows.innerHTML = `<div class="text-neutral-400 italic">No apps passed the filter. Try AI again.</div>`;
        return;
      }

      const pieces=[];
      const shownCount = Math.min(apps.length, visibleCap);
      for(let i=0;i<shownCount;i++){ pieces.push(appCard(apps[i], i)); }
      const needLocked = Math.max(MIN_ROWS - shownCount, 0);
      for(let k=0;k<needLocked;k++){ pieces.push(lockedCard(shownCount + k)); }

      rows.innerHTML = pieces.join('');
    }
    function hydrate(plans){
      renderPlan('planA', plans?.PlanA);
      renderPlan('planB', plans?.PlanB);
      renderPlan('planC', plans?.PlanC);
      renderPlan('planD', plans?.PlanD);
      currentPlans=plans;
    }

    // ---- helpers for cache/saved ----
    function getPrefetched(){
      try{
        const raw = localStorage.getItem('stackscorePrefetchedPlans');
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(!obj?.data) return null;
        return obj;
      }catch{ return null; }
    }
    function getPinned(){
      try{
        const raw = localStorage.getItem('stackscorePinnedPlans');
        if(!raw) return null;
        return JSON.parse(raw);
      }catch{ return null; }
    }

    // ---- network helpers ----
    function safeUserFromStorage(){
      try{
        const raw = localStorage.getItem(ENTRY_KEY);
        if(!raw) return {};
        const obj = JSON.parse(raw);
        return obj && typeof obj === 'object' ? obj : {};
      }catch{
        // Corrupt JSON â€” nuke it so we don't keep failing
        try{ localStorage.removeItem(ENTRY_KEY); }catch{}
        return {};
      }
    }
    async function postJSON(url, body, tries=2, delay=800){
      try{
        const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        const ct=res.headers.get('content-type')||''; if(!res.ok||!ct.includes('application/json')){ const sample=await res.text().catch(()=> ''); throw new Error(`Bad response ${res.status} ${ct} :: ${sample.slice(0,120)}`); }
        return res.json();
      }catch(err){ if(tries>0){ await new Promise(r=>setTimeout(r,delay)); return postJSON(url,body,tries-1,delay*2);} throw err; }
    }
    function buildPayload(){
      const user = safeUserFromStorage();
      return {
        ...user,
        topic:'CREDIT_STACK',
        require_categories:['Budgeting','Credit Monitoring','Credit Builder','Banking','Utilities Reporting','Identity/Monitoring','Dispute/Repair','Subscription Tracking']
      };
    }
    async function fetchPlans({mock=false}={}){ return postJSON(mock?'/api/gpt-plan?mock=1':'/api/gpt-plan', buildPayload()); }

    // Try live with soft timeout; fallback to mock; return {ok, source, data?} or {ok:false, code}
    async function tryLoadWithTimeout(ms=12000){
      try{
        const live = await Promise.race([
          fetchPlans({mock:false}),
          new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),ms))
        ]);
        return { ok:true, source:'ai', data: live };
      }catch(liveErr){
        try{
          const mock = await fetchPlans({mock:true});
          return { ok:true, source:'mock', data: mock };
        }catch{
          return { ok:false, code: liveErr?.message || 'error' };
        }
      }
    }

    function pinPlans(){
      if(!currentPlans) return;
      localStorage.setItem('stackscorePinnedPlans', JSON.stringify(currentPlans));
      localStorage.setItem('stackscorePinnedAt', String(Date.now()));
      pinned=true; hideStatus(); showToast('Saved these plans âœ…'); stampEl.textContent += ' â€¢ saved';
    }
    async function retryAI(silent=false){
      try{
        if(!silent) showSpinner();
        const plans=await fetchPlans({mock:false});
        hydrate(plans);
        setStamp('ai');
        hideStatus();
        if(!silent) showToast('Upgraded with AI âœ¨');
      }catch(e){
        console.warn('Retry failed',e);
        if(!silent) showToast('AI retry failed');
      } finally{
        if(!silent) hideSpinner();
      }
    }
    pinBtn?.addEventListener('click', pinPlans);
    retryBtn?.addEventListener('click', ()=>retryAI(false));

    // ---- fatal error UI ----
    function showFatal(code='timeout'){
      fatalCodeEl.textContent = String(code);
      const saved = getPinned() || getPrefetched()?.data;
      if(saved){ fatalUseSavedBtn.classList.remove('hidden'); } else { fatalUseSavedBtn.classList.add('hidden'); }
      fatalCard.classList.add('on');
    }
    function hideFatal(){ fatalCard.classList.remove('on'); }

    fatalRetryBtn?.addEventListener('click', async ()=>{
      hideFatal(); showSpinner();
      const r = await tryLoadWithTimeout(12000);
      if(r.ok){
        hydrate(r.data);
        setStamp(r.source === 'ai' ? 'ai' : 'mock');
        if(r.source === 'mock') showStatus(); else hideStatus();
        hideSpinner();
      }else{
        hideSpinner(); showFatal(r.code);
      }
    });

    fatalUseSavedBtn?.addEventListener('click', ()=>{
      const pinned = getPinned();
      const pref = getPrefetched();
      const data = pinned || pref?.data;
      if(data){
        hydrate(data);
        setStamp(pinned ? 'ai' : 'mock');
        hideStatus(); hideFatal(); hideSpinner();
      }
    });

    // ---- boot sequence ----
    document.addEventListener('DOMContentLoaded', async ()=>{
      // Watchdog: if we somehow never render/hide the spinner, show friendly error
      const watchdog = setTimeout(()=>{ if(spinner.classList.contains('active')){ showFatal('watchdog'); } }, 15000);

      try{
        showSpinner();

        // 1) Fresh prefetch from wizard (<5min) â†’ render instantly, then quiet refresh
        try{
          const cache = getPrefetched();
          if(cache?.data && (Date.now() - (cache.at||0) < 5*60*1000)){
            hydrate(cache.data);
            setStamp('ai');
            hideStatus();
            hideSpinner();
            fetchPlans({mock:false})
              .then(plans => { if(!pinned){ hydrate(plans); setStamp('ai'); } })
              .catch(()=>{});
            clearTimeout(watchdog);
            return;
          }
        }catch{}

        // 2) Try live â†’ soft-timeout â†’ mock â†’ fatal
        const r = await tryLoadWithTimeout(12000);
        if(r.ok){
          hydrate(r.data);
          setStamp(r.source === 'ai' ? 'ai' : 'mock');
          if(r.source === 'mock'){
            showStatus();
            fetchPlans({mock:false}).then(plans=>{
              if(!pinned){
                hydrate(plans);
                setStamp('ai');
                hideStatus();
                showToast('Upgraded with AI âœ¨');
              }
            }).catch(e=>console.warn('Background AI failed', e));
          }else{
            hideStatus();
          }
          hideSpinner();
        }else{
          console.warn('Live+Mock failed; showing friendly error UI', r.code);
          hideSpinner();
          showFatal(r.code);
        }
      }catch(err){
        console.error('Boot error', err);
        hideSpinner();
        showFatal('boot');
      }finally{
        clearTimeout(watchdog);
      }
    });

    // Upgrade quietly if network returns
    window.addEventListener('online', ()=>{ if(!pinned && !fatalCard.classList.contains('on')) retryAI(true); });
  </script>
</body>
</html>



