<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900 text-gray-100">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StackScore Onboarding Wizard</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Slides */
    form { position: relative; }
    fieldset {
      opacity: 0; transform: translateX(100%); pointer-events: none;
      position: absolute; inset: 0;
      transition: opacity .5s ease, transform .5s ease;
    }
    fieldset.active     { opacity: 1; transform: translateX(0); pointer-events: auto; position: relative; }
    fieldset.exit-left  { transform: translateX(-100%); opacity: 0; }
    fieldset.exit-right { transform: translateX( 100%); opacity: 0; }

    /* Floating number array (same timing as preview) */
    @keyframes floatUp {
      0%   { transform: translateY(10px); opacity: 0; }
      50%  { opacity: 1; }
      100% { transform: translateY(-10px); opacity: 0; }
    }
    .score-burst span { animation: floatUp 4s ease-in-out infinite; }
    .score-burst span:nth-child(odd)  { animation-delay: 1s; }
    .score-burst span:nth-child(even) { animation-delay: 2s; }

    /* Stack bars */
    .stack-bar{
      height: 56px;
      display:flex; align-items:center; justify-content:center;
      border-radius: 10px;
      background: linear-gradient(to bottom, rgb(23 23 23), rgb(15 15 15));
      border: 8px solid rgb(132 204 22 / 1);
      box-shadow: 0 0 0 0 rgba(132,204,22,.25);
      color: #cbd5e1; font-weight: 700; letter-spacing:.02em;
      text-transform: uppercase; font-size: .85rem;
      animation: stackIn .5s ease forwards, stackGlow 2.6s ease-in-out infinite;
      opacity:0; transform: translateY(8px) scale(.98);
    }
    #stackBars .stack-bar:nth-child(1){ animation-delay: .05s, 0s; }
    #stackBars .stack-bar:nth-child(2){ animation-delay: .12s, .1s; }
    #stackBars .stack-bar:nth-child(3){ animation-delay: .19s, .2s; }
    #stackBars .stack-bar:nth-child(4){ animation-delay: .26s, .3s; }
    #stackBars .stack-bar:nth-child(5){ animation-delay: .33s, .4s; }
    @keyframes stackIn{ to{ opacity:1; transform: translateY(0) scale(1); } }
    @keyframes stackGlow{ 0%,100%{ box-shadow: 0 0 0 0 rgba(132,204,22,.18); } 50%{ box-shadow: 0 0 22px 4px rgba(132,204,22,.28); } }

    /* Build overlay */
    #buildOverlay{position:fixed;inset:0;display:none;z-index:80}
    #buildOverlay.on{display:block}
    #buildOverlay .bg{position:absolute;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(10px) saturate(105%)}
    #buildOverlay .wrap{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none}

    /* Error card */
    #errorCard{ pointer-events:auto; display:none; }
    #errorCard.on{ display:block; }
    .error-card{
      width:min(560px,92vw);
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(23,23,23,.95), rgba(12,12,12,.95));
      border:1px solid #3f3f46;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    .error-actions > button{
      transition: transform .08s ease, filter .2s ease;
    }
    .error-actions > button:active{ transform: translateY(1px) }
  </style>

  <!-- Fresh start helper -->
  <script>
    (function () {
      const qp = new URLSearchParams(location.search);
      if (!sessionStorage.getItem('wizardFresh') || qp.get('fresh') === '1') {
        // keep any existing plans; only reset answers
        localStorage.removeItem('stackscoreUserData');
        sessionStorage.setItem('wizardFresh', '1');
      }
      if (!localStorage.getItem('entryPoint')) {
        localStorage.setItem('entryPoint', 'direct');
      }
    })();
  </script>
</head>

<body class="flex items-center justify-center min-h-full p-4 pt-8">
  <!-- Brand + Reset -->
  <div class="absolute top-8 left-4 flex items-center gap-3 z-50">
    <svg class="text-lime-400" xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M4 4h16v3H4z"></path>
      <path d="M4 10.5h16v3H4z"></path>
      <path d="M4 17h16v3H4z"></path>
    </svg>
    <span class="text-lg font-semibold tracking-tight text-white">StackScore</span>
    <a href="#"
       class="ml-4 text-sm underline text-white/70 hover:text-white"
       onclick="localStorage.removeItem('stackscoreUserData'); sessionStorage.removeItem('wizardFresh'); location.href = location.pathname + '?fresh=1'; return false;">
      Reset
    </a>
  </div>

  <!-- Build overlay (shown on final CTA click) -->
  <div id="buildOverlay" aria-live="polite" aria-busy="true">
    <div class="bg"></div>

    <!-- Floating numbers / working state -->
    <div class="wrap">
      <div class="text-center">
        <div class="score-burst pointer-events-none w-[520px] max-w-[86vw] select-none relative mx-auto" style="margin:-20px 0; height:3.5rem;">
          <span class="absolute top-0 left-1/3 text-xl font-bold text-lime-400">+25</span>
          <span class="absolute top-1 left-1/4 text-2xl font-bold text-lime-300">+111</span>
          <span class="absolute top-10 left-10 text-xl font-bold text-lime-400">+65</span>
          <span class="absolute top-16 left-1/2 text-2xl font-bold text-lime-500">+53</span>
          <span class="absolute top-6 right-1/4 text-xl font-bold text-lime-400">+77</span>
          <span class="absolute top-20 right-8 text-xl font-bold text-lime-300">+121</span>
        </div>
        <div id="overlayCaption" class="text-sm text-slate-300 mt-2">'Building your stackâ€¦';</div>
      </div>
    </div>

    <!-- Friendly error UI -->
    <div id="errorCard" class="fixed inset-0 grid place-items-center p-4" role="dialog" aria-modal="true" aria-labelledby="err-title" aria-describedby="err-desc">
      <div class="error-card p-6">
        <div class="flex items-start gap-4">
          <div class="text-3xl">ðŸ˜•</div>
          <div class="flex-1">
            <h2 id="err-title" class="text-xl font-semibold mb-1">We couldnâ€™t build your stack right now</h2>
            <p id="err-desc" class="text-sm text-slate-300">
              Our AI helper had trouble and the quick preview wasnâ€™t available. Your answers are savedâ€”try again, or open the preview where weâ€™ll retry automatically.
            </p>
          </div>
        </div>

        <div class="error-actions mt-5 flex flex-wrap gap-3">
          <button id="errRetry" class="px-4 py-2 rounded-full bg-lime-400 text-black font-semibold hover:brightness-110">
            Try again
          </button>
          <button id="errPreview" class="px-4 py-2 rounded-full border border-white/25 hover:bg-white/5">
            Continue to preview
          </button>
          <button id="errClose" class="ml-auto px-4 py-2 rounded-full border border-white/25 hover:bg-white/5">
            Close
          </button>
        </div>

        <div class="mt-4 text-xs text-slate-400">
          Error code: <span id="errCode">timeout</span>
        </div>
      </div>
    </div>
  </div>

  <form id="wizard" class="w-full max-w-xl space-y-6 pb-20" autocomplete="off">
    <!-- Avatar + greeting -->
    <div class="flex items-center space-x-3">
      <img class="w-8 h-8 rounded-full" src="https://i.pravatar.cc/40?img=68" alt="Avatar"/>
      <span class="text-neutral-400 text-sm">Welcome back, Joseph</span>
    </div>

    <!-- Dots -->
    <div id="dots" class="flex justify-center gap-2 mt-4" aria-hidden="true">
      <span class="dot w-2.5 h-2.5 rounded-full bg-lime-500"></span>
      <span class="dot w-2.5 h-2.5 rounded-full bg-gray-600"></span>
      <span class="dot w-2.5 h-2.5 rounded-full bg-gray-600"></span>
      <span class="dot w-2.5 h-2.5 rounded-full bg-gray-600"></span>
      <span class="dot w-2.5 h-2.5 rounded-full bg-gray-600"></span>
      <span class="dot w-2.5 h-2.5 rounded-full bg-gray-600"></span>
    </div>

    <!-- Progress bar -->
    <div class="w-full bg-gray-700 rounded-full h-2 overflow-hidden mt-3" aria-hidden="true">
      <div id="progress" class="bg-lime-500 h-full transition-all duration-500" style="width:0%"></div>
    </div>

    <!-- Step label -->
    <p id="stepLabel" class="text-center text-neutral-400 text-sm" aria-live="polite">Step 1 of 6</p>

    <!-- STEP 1 â€“ Living situation -->
    <fieldset class="active" data-required="radio:housing">
      <legend class="text-2xl font-semibold mb-6">Living situation</legend>
      <div class="space-y-4">
        <label class="flex items-center space-x-3 cursor-pointer">
          <input class="sr-only peer" type="radio" name="housing" value="rent"/>
          <span class="w-5 h-5 rounded-full border-2 border-neutral-600 peer-checked:ring-4 peer-checked:ring-lime-500 peer-checked:bg-lime-500 transition-all duration-200"></span>
          <span>Rent</span>
        </label>
        <label class="flex items-center space-x-3 cursor-pointer">
          <input class="sr-only peer" type="radio" name="housing" value="mortgage"/>
          <span class="w-5 h-5 rounded-full border-2 border-neutral-600 peer-checked:ring-4 peer-checked:ring-lime-500 peer-checked:bg-lime-500 transition-all duration-200"></span>
          <span>Mortgage</span>
        </label>
        <label class="flex items-center space-x-3 cursor-pointer">
          <input class="sr-only peer" type="radio" name="housing" value="neither"/>
          <span class="w-5 h-5 rounded-full border-2 border-neutral-600 peer-checked:ring-4 peer-checked:ring-lime-500 peer-checked:bg-lime-500 transition-all duration-200"></span>
          <span>Neither</span>
        </label>
      </div>
      <div class="mt-10 flex justify-end">
        <button type="button" class="next px-6 py-2 rounded-full text-black font-semibold bg-gradient-to-r from-lime-400 to-lime-500 hover:brightness-110 transition-all">Next</button>
      </div>
    </fieldset>

    <!-- STEP 2 â€“ Subscriptions -->
    <fieldset>
      <legend class="text-2xl font-semibold mb-6">Entertainment subscriptions</legend>
      <div class="space-y-4">
        <label class="flex items-center space-x-3 cursor-pointer">
          <input class="sr-only peer" type="checkbox" name="subs" value="Netflix"/>
          <span class="w-5 h-5 rounded border-2 border-neutral-600 peer-checked:bg-lime-500 peer-checked:border-lime-500 transition-all duration-200 flex items-center justify-center">
            <svg class="w-3 h-3 text-white hidden peer-checked:block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"></path></svg>
          </span>
          <span>Netflix</span>
        </label>
        <label class="flex items-center space-x-3 cursor-pointer">
          <input class="sr-only peer" type="checkbox" name="subs" value="Spotify"/>
          <span class="w-5 h-5 rounded border-2 border-neutral-600 peer-checked:bg-lime-500 peer-checked:border-lime-500 transition-all duration-200 flex items-center justify-center">
            <svg class="w-3 h-3 text-white hidden peer-checked:block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"></path></svg>
          </span>
          <span>Spotify</span>
        </label>
        <label class="flex items-center space-x-3 cursor-pointer">
          <input class="sr-only peer" type="checkbox" name="subs" value="HBO Max"/>
          <span class="w-5 h-5 rounded border-2 border-neutral-600 peer-checked:bg-lime-500 peer-checked:border-lime-500 transition-all duration-200 flex items-center justify-center">
            <svg class="w-3 h-3 text-white hidden peer-checked:block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"></path></svg>
          </span>
          <span>HBO Max</span>
        </label>
        <label class="flex items-center space-x-3 cursor-pointer">
          <input class="sr-only peer" type="checkbox" name="subs" value="Disney+"/>
          <span class="w-5 h-5 rounded border-2 border-neutral-600 peer-checked:bg-lime-500 peer-checked:border-lime-500 transition-all duration-200 flex items-center justify-center">
            <svg class="w-3 h-3 text-white hidden peer-checked:block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"></path></svg>
          </span>
          <span>Disney+</span>
        </label>
      </div>
      <div class="mt-10 flex justify-between">
        <button type="button" class="back px-6 py-2 rounded-full border border-white/30 text-white bg-neutral-900 hover:bg-neutral-800 transition-all">Back</button>
        <button type="button" class="next px-6 py-2 rounded-full text-black font-semibold bg-gradient-to-r from-lime-400 to-lime-500 hover:brightness-110 transition-all">Next</button>
      </div>
    </fieldset>

    <!-- STEP 3 â€“ Tool preference -->
    <fieldset data-required="radio:tools">
      <legend class="text-2xl font-semibold mb-6">Tool preference</legend>
      <div class="space-y-4">
        <label class="flex items-center space-x-3 cursor-pointer">
          <input class="sr-only peer" type="radio" name="tools" value="auto"/>
          <span class="w-5 h-5 rounded-full border-2 border-neutral-600 peer-checked:ring-4 peer-checked:ring-lime-500 peer-checked:bg-lime-500 transition-all duration-200"></span>
          <span>Automated (recommended)</span>
        </label>
        <label class="flex items-center space-x-3 cursor-pointer">
          <input class="sr-only peer" type="radio" name="tools" value="manual"/>
          <span class="w-5 h-5 rounded-full border-2 border-neutral-600 peer-checked:ring-4 peer-checked:ring-lime-500 peer-checked:bg-lime-500 transition-all duration-200"></span>
          <span>Manual</span>
        </label>
        <label class="flex items-center space-x-3 cursor-pointer">
          <input class="sr-only peer" type="radio" name="tools" value="not-sure"/>
          <span class="w-5 h-5 rounded-full border-2 border-neutral-600 peer-checked:ring-4 peer-checked:ring-lime-500 peer-checked:bg-lime-500 transition-all duration-200"></span>
          <span>Not sure</span>
        </label>
      </div>
      <div class="mt-10 flex justify-between">
        <button type="button" class="back px-6 py-2 rounded-full border border-white/30 text-white bg-neutral-900 hover:bg-neutral-800 transition-all">Back</button>
        <button type="button" class="next px-6 py-2 rounded-full text-black font-semibold bg-gradient-to-r from-lime-400 to-lime-500 hover:brightness-110 transition-all">Next</button>
      </div>
    </fieldset>

    <!-- STEP 4 â€“ Employment -->
    <fieldset data-required="radio:employment">
      <legend class="text-2xl font-semibold mb-6">Employment status</legend>
      <div class="space-y-4">
        <label class="flex items-center space-x-3 cursor-pointer"><input class="sr-only peer" type="radio" name="employment" value="employed"/><span class="w-5 h-5 rounded-full border-2 border-neutral-600 peer-checked:ring-4 peer-checked:ring-lime-500 peer-checked:bg-lime-500 transition-all duration-200"></span><span>Employed</span></label>
        <label class="flex items-center space-x-3 cursor-pointer"><input class="sr-only peer" type="radio" name="employment" value="self-employed"/><span class="w-5 h-5 rounded-full border-2 border-neutral-600 peer-checked:ring-4 peer-checked:ring-lime-500 peer-checked:bg-lime-500 transition-all duration-200"></span><span>Self-employed</span></label>
        <label class="flex items-center space-x-3 cursor-pointer"><input class="sr-only peer" type="radio" name="employment" value="unemployed"/><span class="w-5 h-5 rounded-full border-2 border-neutral-600 peer-checked:ring-4 peer-checked:ring-lime-500 peer-checked:bg-lime-500 transition-all duration-200"></span><span>Unemployed</span></label>
        <label class="flex items-center space-x-3 cursor-pointer"><input class="sr-only peer" type="radio" name="employment" value="student"/><span class="w-5 h-5 rounded-full border-2 border-neutral-600 peer-checked:ring-4 peer-checked:ring-lime-500 peer-checked:bg-lime-500 transition-all duration-200"></span><span>Student</span></label>
      </div>
      <div class="mt-10 flex justify-between">
        <button type="button" class="back px-6 py-2 rounded-full border border-white/30 text-white bg-neutral-900 hover:bg-neutral-800 transition-all">Back</button>
        <button type="button" class="next px-6 py-2 rounded-full text-black font-semibold bg-gradient-to-r from-lime-400 to-lime-500 hover:brightness-110 transition-all">Next</button>
      </div>
    </fieldset>

    <!-- STEP 5 â€“ Goal -->
    <fieldset data-required="radio:goal">
      <legend class="text-2xl font-semibold mb-6">Goal timeline</legend>
      <div class="space-y-4">
        <label class="flex items-center space-x-3 cursor-pointer"><input class="sr-only peer" type="radio" name="goal" value="30"/><span class="w-5 h-5 rounded-full border-2 border-neutral-600 peer-checked:ring-4 peer-checked:ring-lime-500 peer-checked:bg-lime-500 transition-all duration-200"></span><span>ASAP (30 days)</span></label>
        <label class="flex items-center space-x-3 cursor-pointer"><input class="sr-only peer" type="radio" name="goal" value="90"/><span class="w-5 h-5 rounded-full border-2 border-neutral-600 peer-checked:ring-4 peer-checked:ring-lime-500 peer-checked:bg-lime-500 transition-all duration-200"></span><span>90 Days</span></label>
        <label class="flex items-center space-x-3 cursor-pointer"><input class="sr-only peer" type="radio" name="goal" value="flexible"/><span class="w-5 h-5 rounded-full border-2 border-neutral-600 peer-checked:ring-4 peer-checked:ring-lime-500 peer-checked:bg-lime-500 transition-all duration-200"></span><span>Flexible</span></label>
      </div>
      <div class="mt-10 flex justify-between">
        <button type="button" class="back px-6 py-2 rounded-full border border-white/30 text-white bg-neutral-900 hover:bg-neutral-800 transition-all">Back</button>
        <button type="button" class="next px-6 py-2 rounded-full text-black font-semibold bg-gradient-to-r from-lime-400 to-lime-500 hover:brightness-110 transition-all">Next</button>
      </div>
    </fieldset>

    <!-- STEP 6 â€“ Budget -->
    <fieldset data-required="range:budgetRange">
      <legend class="text-2xl font-semibold mb-6">Whatâ€™s your StackScore budget?</legend>
      <p class="text-neutral-400 mb-8">Tell us what you can comfortably invest monthly. Weâ€™ll customize your plan to give you the most boost for your budget.</p>
      <div>
        <input id="budgetRange" class="w-full accent-lime-500" type="range" min="20" max="200" step="5" value="45"/>
        <p id="budgetValue" class="mt-4 text-lg font-medium text-center">$45 / month</p>
        <p id="budgetBadge" class="mt-2 text-sm text-neutral-400 text-center">Lite Stack</p>
      </div>
      <div class="mt-10 flex justify-between">
        <button type="button" class="back px-6 py-2 rounded-full border border-white/30 text-white bg-neutral-900 hover:bg-neutral-800 transition-all">Back</button>
        <button type="button" class="next px-6 py-2 rounded-full text-black font-semibold bg-gradient-to-r from-lime-400 to-lime-500 hover:brightness-110 transition-all">Next</button>
      </div>
    </fieldset>

    <!-- COMPLETION -->
    <fieldset>
      <div class="text-center space-y-10 max-w-md mx-auto">
        <div class="score-burst pointer-events-none w-full select-none relative" style="margin:-20px 0; height:3.5rem;">
          <span class="absolute top-0 left-1/3 text-xl font-bold text-lime-400">+25</span>
          <span class="absolute top-1 left-1/4 text-2xl font-bold text-lime-300">+111</span>
          <span class="absolute top-10 left-10 text-xl font-bold text-lime-400">+65</span>
          <span class="absolute top-16 left-1/2 text-2xl font-bold text-lime-500">+53</span>
          <span class="absolute top-6 right-1/4 text-xl font-bold text-lime-400">+77</span>
          <span class="absolute top-20 right-8 text-xl font-bold text-lime-300">+121</span>
        </div>

        <h1 class="text-3xl font-bold -mt-2 mb-1">Your Stack is Ready</h1>
        <p class="text-lg text-gray-400 mb-2">Hereâ€™s the custom lineup of apps weâ€™ve prepared to help you boost your credit score.</p>

        <div id="stackBars" class="flex flex-col gap-4 items-stretch">
          <div class="stack-bar">SUBSCRIPTION TRACKERS</div>
          <div class="stack-bar">CREDIT BUILDERS</div>
          <div class="stack-bar">DISPUTE TOOLS</div>
          <div class="stack-bar">UTILITY REPORTING</div>
          <div class="stack-bar">AI INSIGHTS</div>
        </div>

        <a id="final-cta" class="inline-block px-6 py-3 bg-gradient-to-r from-lime-400 to-emerald-500 text-black font-semibold rounded-full hover:brightness-110 transition" href="/preview.html">
          ðŸš€ View Your Plans
        </a>
      </div>
    </fieldset>
  </form>

  <script>
    /* ---------- persistence ---------- */
    const form = document.getElementById('wizard');
    const steps = Array.from(form.querySelectorAll('fieldset'));
    const progress = document.getElementById('progress');
    const dots = document.querySelectorAll('#dots .dot');
    const stepLabel = document.getElementById('stepLabel');
    const totalSteps = 6; // excludes completion
    let current = 0;

    function getData(){ try { return JSON.parse(localStorage.getItem('stackscoreUserData')) || {}; } catch { return {}; } }
    function setData(next){ localStorage.setItem('stackscoreUserData', JSON.stringify(next)); }
    function collect(){
      return {
        housing:    form.querySelector('input[name="housing"]:checked')?.value || null,
        subs:       Array.from(form.querySelectorAll('input[name="subs"]:checked')).map(x => x.value),
        tools:      form.querySelector('input[name="tools"]:checked')?.value || null,
        employment: form.querySelector('input[name="employment"]:checked')?.value || null,
        goal:       form.querySelector('input[name="goal"]:checked')?.value || null,
        budget:     document.getElementById('budgetRange')?.value || null
      };
    }
    function persist(){ setData({ ...getData(), ...collect() }); }
    form.addEventListener('change', persist);
    document.getElementById('budgetRange')?.addEventListener('input', persist);

    // Prefill
    (function () {
      const saved = getData();
      if (!saved) return;
      const pick = (n,v) => { const el = form.querySelector(`input[name="${n}"][value="${v}"]`); if(el) el.checked = true; };
      if (saved.housing) pick('housing', saved.housing);
      if (Array.isArray(saved.subs)) saved.subs.forEach(v => pick('subs', v));
      if (saved.tools) pick('tools', saved.tools);
      if (saved.employment) pick('employment', saved.employment);
      if (saved.goal) pick('goal', saved.goal);
      if (saved.budget){ const r = document.getElementById('budgetRange'); if(r){ r.value = saved.budget; updateBudgetDisplay(saved.budget); } }
    })();

    // Budget display
    const range = document.getElementById('budgetRange');
    const valueOut = document.getElementById('budgetValue');
    const badgeOut = document.getElementById('budgetBadge');
    function updateBudgetDisplay(val){
      if(!valueOut||!badgeOut) return;
      valueOut.textContent = `$${val} / month`;
      const n = Number(val);
      badgeOut.textContent = n >= 100 ? 'Max Stack' : n >= 50 ? 'Core Stack' : 'Lite Stack';
    }
    range?.addEventListener('input',(e)=>updateBudgetDisplay(e.target.value));
    if(range) updateBudgetDisplay(range.value);

    // Validation + nav
    function stepIsValid(idx){
      const fs = steps[idx];
      const req = fs.getAttribute('data-required');
      if(!req) return true;
      const [kind, key] = req.split(':');
      if(kind==='radio') return !!form.querySelector(`input[name="${key}"]:checked`);
      if(kind==='range') return !!document.getElementById(key);
      return true;
    }
    function showStep(index, dir){
      steps[current].classList.remove('active');
      if (dir === 'next') steps[current].classList.add('exit-left');
      if (dir === 'back') steps[current].classList.add('exit-right');
      setTimeout(()=>steps[current].classList.remove('exit-left','exit-right'), 500);
      current = index;
      steps[current].classList.add('active');
      const pct = (Math.min(current, totalSteps - 1) / (totalSteps - 1)) * 100;
      progress.style.width = `${pct}%`;
      updateIndicators();
      setData({ ...getData(), step: current });
    }
    form.addEventListener('click', (e)=>{
      const nextBtn = e.target.closest('.next');
      const backBtn = e.target.closest('.back');
      if(nextBtn){
        e.preventDefault();
        if(!stepIsValid(current)){
          const fs = steps[current];
          if(!fs.querySelector('.soft-required-msg')){
            const msg = document.createElement('div');
            msg.className = 'soft-required-msg mt-3 text-sm text-amber-400';
            msg.textContent = 'Please make a selection to continue.';
            fs.appendChild(msg); setTimeout(()=>msg.remove(), 2500);
          }
          return;
        }
        persist();
        if(current < steps.length - 1) showStep(current+1, 'next');
      }
      if(backBtn){
        e.preventDefault();
        if(current > 0) showStep(current-1, 'back');
      }
    });
    function updateIndicators(){
      dots.forEach((dot,i)=>{ dot.classList.toggle('bg-lime-500', i===current); dot.classList.toggle('bg-gray-600', i!==current); });
      if(current < totalSteps){ stepLabel.textContent = `Step ${current+1} of ${totalSteps}`; stepLabel.classList.remove('invisible'); document.getElementById('dots').classList.remove('invisible'); }
      else { stepLabel.classList.add('invisible'); document.getElementById('dots').classList.add('invisible'); }
    }
    updateIndicators();

    /* ----------- Prefetch plans on final CTA with immediate overlay ----------- */
    const overlay       = document.getElementById('buildOverlay');
    const overlayText   = document.getElementById('overlayCaption');
    const errorCard     = document.getElementById('errorCard');
    const errCodeEl     = document.getElementById('errCode');
    const errRetryBtn   = document.getElementById('errRetry');
    const errPreviewBtn = document.getElementById('errPreview');
    const errCloseBtn   = document.getElementById('errClose');
    const finalCta      = document.getElementById('final-cta');

    function showErrorUi(code='timeout'){
      errCodeEl.textContent = String(code);
      errorCard.classList.add('on');
      overlayText.textContent = 'Something went wrong.';
    }
    function hideErrorUi(){
      errorCard.classList.remove('on');
      overlayText.textContent = 'Building your stackâ€¦';
    }

    async function postJSON(url, body, tries=2, delay=800){
      try{
        const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        const ct = res.headers.get('content-type')||'';
        if(!res.ok || !ct.includes('application/json')){
          const sample = await res.text().catch(()=> ''); throw new Error(`Bad response ${res.status} ${ct} :: ${sample.slice(0,120)}`);
        }
        return res.json();
      }catch(err){
        if(tries>0){ await new Promise(r=>setTimeout(r, delay)); return postJSON(url, body, tries-1, delay*1.5); }
        throw err;
      }
    }

    function buildPayload(){
      const ENTRY_KEY = 'stackscoreUserData';
      const user = JSON.parse(localStorage.getItem(ENTRY_KEY) || '{}');
      return { ...user, topic:'CREDIT_STACK', require_categories:[
        'Budgeting','Credit Monitoring','Credit Builder','Banking','Utilities Reporting',
        'Identity/Monitoring','Dispute/Repair','Subscription Tracking'
      ]};
    }

    function cachePlans(data){
      try{ localStorage.setItem('stackscorePrefetchedPlans', JSON.stringify({ at: Date.now(), data })); }catch(e){ /* ignore */ }
    }

    function goPreview(){
      window.location.href = '/preview.html';
    }

    async function tryPrefetchWithTimeout(ms=12000){
      const payload = buildPayload();
      const livePromise = postJSON('/api/gpt-plan', payload);
      const timeout = new Promise((resolve, reject)=> setTimeout(()=> reject(new Error('timeout')), ms));
      try{
        const live = await Promise.race([livePromise, timeout]);
        cachePlans(live);
        return { ok:true, source:'live' };
      }catch(liveErr){
        // Try mock as quick preview
        try{
          const mock = await postJSON('/api/gpt-plan?mock=1', payload);
          cachePlans(mock);
          return { ok:true, source:'mock' };
        }catch(mockErr){
          return { ok:false, code: liveErr?.message || 'error' };
        }
      }
    }

    finalCta?.addEventListener('click', async (e)=>{
      e.preventDefault();
      overlay.classList.add('on');   // show numbers immediately
      persist();                     // save latest answers
      hideErrorUi();

      const result = await tryPrefetchWithTimeout(12000);
      if(result.ok){
        // Navigate; preview will stamp LIVE/MOCK accordingly and refresh in background
        goPreview();
      }else{
        showErrorUi(result.code);
      }
    });

    // Error UI buttons
    errRetryBtn?.addEventListener('click', async ()=>{
      hideErrorUi();
      overlayText.textContent = 'Retryingâ€¦';
      const result = await tryPrefetchWithTimeout(12000);
      if(result.ok) goPreview();
      else showErrorUi(result.code);
    });
    errPreviewBtn?.addEventListener('click', goPreview);
    errCloseBtn?.addEventListener('click', ()=>{
      hideErrorUi();
      overlay.classList.remove('on');
    });

    // If connection returns while overlay is open, try again in background
    window.addEventListener('online', async ()=>{
      if(overlay.classList.contains('on') && !errorCard.classList.contains('on')){
        const r = await tryPrefetchWithTimeout(8000);
        if(r.ok) goPreview();
      }
    });
  </script>
</body>
</html>

